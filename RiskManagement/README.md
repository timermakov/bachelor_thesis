# Разработка системы риск-менеджмента при торговле акциями на фондовом рынке
Ермаков Тимофей Сергеевич

Университет ИТМО, 4 курс, P34092, № ИСУ 311733

## План исследования

- [x] Изучить и зафиксировать статьи по методам риск-менеджмента при дневном/внутридневном трейдинге/спекуляциях на рынке акций с использованием различных методов
- [x]  Попробовать изученные "на бумаге" методы перевести в код для автоматического выставления стоп-лоссов и тейк-профитов на исторических значениях котировок
- [x]  Изучить результаты - наиболее эффективные методы с наибольшей прибылью
- [x]  Внедрить систему в проект
- [x]  Проработка глав ВКР

## Система риск-менеджмента для торговли

Разработана система для расчета уровней риск-менеджмента и тестирования на исторических данных разных стратегий с определением stop-loss'ов (ограничение убытков) и take profit'ов (фиксация прибыли).

Для эффективного риск-менеджмента нужно уметь рассчитывать и обновлять (trailing) значения stop-loss'ов и take profit'ов по разным методикам и подбирать наиболее подходящие варианты по результатам тестирования.

Ниже представлены поддерживаемые методики. 

Выставление stop-loss:

1. Минимум предыдущего торгового дня для покупки, максимум для продажи
2. Минимумы недельные/месячные/трехмесячные
3. VolatilityStop
4. Уровни 50-дневной и 18 дневной скользящей средней
5. Другие подходы.

Оределение take profit:

1. Расстояние до 18 или 50-дневной скользящих средних (смотря что ближе)
2. Достижения максимумов и минимумов недельных, месячных, трехмесячных
3. Фиксированный % добавляемых или вычитаемый от цены закрытия предыдущей свечи.

## Тестирование на исторических данных

В файле конфигурации config_ru.json уже заданы 5 акций - OZON, AFLT, GAZP, SBER, NLMK.

### Функциональные возможности

- Получение исторических данных через Tinkoff Invest API
- Расчет стоп-лоссов по различным методикам
- Расчет тейк-профитов по различным методикам
- Проведение бэктестов на исторических данных
- Генерация графиков и отчетов
- Поддержка нескольких тикеров одновременно

### Библиотеки
Версии описаны в requirements.txt

- Python 3.8+
- tinkoff-invest 0.2.0+
- pandas, numpy
- matplotlib
- talib
- backtrader

### Установка
Если возникают проблемы с установкой, отправьте Issue на GitHub или свяжитесь со мной по контактам в профиле.

1. Склонировать репозиторий, если это ещё не сделали и перейти в эту папку

	```
	git clone https://github.com/timermakov/bachelor_thesis.git

	cd RiskManagement/
	```
2. Создать виртуальное окружение 

	`python -m venv venv`

3. Активировать виртуальное окружение:
   - Windows: 
   `venv\Scripts\activate`
   - Linux/Mac: 
   `source venv/bin/activate`

4. Установить зависимости 

	`pip install -r requirements.txt`

5. Создать личный токен песочницы API Т-Банк Инвестиции https://www.tbank.ru/invest/settings/api/
5. Установить токен в терминале в переменные окружения (Linux):
   ```bash
   export TINKOFF_TOKEN='ваш_токен'
   ```
   или для Windows (в Command Prompt):
   ```
   set TINKOFF_TOKEN=ваш_токен
   ```

### Структура подпроекта

- **`config_ru.json` - Конфигурационный файл с настройками тестируемых акций и параметров риск-менеджмента**. Измените значения параметров при необходимости.
- **`config_web_ru.json` - Конфигурационный файл для запросов, приходящих из сети**. Измените значения параметров при необходимости на сайте или в файле.
- `config_utils.py` - утилиты для работы с конфигурационными файлами, включая загрузку и сохранение настроек.
- `tinkoff_data.py` - модуль для работы с T-Bank Invest API и получения исторических данных
- `backtrader_simple.py` - простая версия тестирования одной стратегии
- `backtrader_complex.py` - комплекс систем риск-менеджмента с тестированием стратегии на исторических данных
- `analysis.py` - скрипт для анализа результатов бэктестинга, включая генерацию сводных таблиц и графиков по каждой акции в отдельности
- `comparison.py` - скрипт для сравнения результатов бэктестинга с группировкой всех акций

### Использование

#### Система риск-менеджмента с простой стратегией

```
python backtrader_simple.py
```
Генерирует в процессе запуска графики с возможностью приближать и рассмотривать графики, сохраняет отчёты в папке `results_bt_simple`.


#### Исследование эффективности различных методов риск-менеджмента со сложной стратегией

Можно установить в `config_ru.json` параметр `run_all_variants: True`, и запустить команду ниже, чтобы выполнить полный перебор различных вариантов выставления Take Profit и Stop Loss на заданных акциях.

```
python backtrader_complex.py
```

В результате в папке `results_bt_complex` появятся или обновятся данные о запуске каждого из вариантов.

Для генерации графиков со сравнением всех результатов друг с другом (папка `plots_bt_complex`), запустить:
```
python comparison.py
```

```
python analysis.py
```

### Конфигурация

Конфигурация находится в файле `config_ru.json`. 


### Доступные методы стоп-лосса

- `daily_minmax` - На основе минимума/максимума предыдущего дня
- `volatility_stop` - На основе волатильности (ATR)
- `weekly_minmax` - На основе недельного минимума
- `monthly_minmax` - На основе месячного минимума
- `quarterly_minmax` - На основе квартального минимума
- `MA_50_18` - На основе скользящих средних

### Доступные методы тейк-профита

- `ma_distance` - На основе расстояния до скользящих средних
- `weekly_minmax` - На основе недельного минимума/максимума
- `monthly_minmax` - На основе месячного минимума/максимума
- `quarterly_minmax` - На основе квартального минимума/максимума
- `prev_bar_5_percent` - На основе предыдущей свечи +-5%

### Результаты

Результаты сохраняются в следующих каталогах:
- `results_bt_complex/` - Графики и текстовые отчеты по результатам бэктестинга множества возможных вариантов риск-менеджмента
- `results_bt_simple/` - Графики и текстовые отчеты по результатам бэктестинга 1 базовой стратегии
- `plots_bt_complex`

Содержимое результатов:
- график изменения баланса (начальное значение капитала - 1 млн рублей),
- график изменения цены на акцию с возможными на исторических данных отметками входа и уровнями Take Profit / Stop Loss
- отчёт в формате **Markdown (.md)** со сводкой по ключевым метрикам стратегии. Файл можно открыть на GitHub, с помощью Preview в IDE или [любого удобного Markdown-редактора](https://github.com/mundimark/awesome-markdown-editors).


### Примечания
- **Не является индивидуальной инвестиционной рекомендацией**
Проверка стратегии на исторических данных является лишь гипотезой и может показать потенциал тех или иных возможностей "задним числом", в реальных торгах стратегия может показывать иные результаты из-за десятков различных факторов.

- Для получения новых данных **необходим токен песочницы API Т-Банк Инвестиций**: https://www.tbank.ru/invest/settings/api/
- **Максимальный период получения свечей за один запрос — один календарный год**, но можно выполнять несколько запросов в пределах лимитов: https://developer.tbank.ru/invest/intro/intro/limits
 